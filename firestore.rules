rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------------------------------------------------
    // Helper functions
    // -----------------------------------------------------------------------

    // Returns true when the requesting user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Returns the role stored in Firestore for the calling user
    function callerRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Returns true when the calling user is the admin
    function isAdmin() {
      return isAuth() && callerRole() == "admin";
    }

    // Returns true when the calling user owns the document
    function isSelf(uid) {
      return isAuth() && request.auth.uid == uid;
    }

    // -----------------------------------------------------------------------
    // users collection
    // -----------------------------------------------------------------------
    match /users/{uid} {

      // READ
      // • Admin can read any user document
      // • Users can read their own document only
      allow read: if isAdmin() || isSelf(uid);

      // CREATE
      // • Admin can create new user documents (member / projectLead)
      // • A user may create their own document only when registering as admin
      //   (first-time setup — guarded in app logic + Cloud Function)
      allow create: if isAdmin()
                    || (isSelf(uid) && request.resource.data.role == "admin");

      // UPDATE
      // • Admin can update any field on any document
      // • Regular users/projectLeads CANNOT change their role
      allow update: if isAdmin()
                    || (isSelf(uid)
                        && request.resource.data.role == resource.data.role);

      // DELETE
      // • Only admin can delete user documents
      allow delete: if isAdmin();
    }

    // -----------------------------------------------------------------------
    // communities collection  (microcommunities)
    // -----------------------------------------------------------------------
    match /communities/{communityID} {
      // Only admin can create, read, update, delete communities
      allow read, write: if isAdmin();

      // Feed subcollection — community members + admin can read & create
      match /feed/{messageID} {
        allow read, create: if isAdmin()
                            || (isAuth() && resource == null)
                            || isAuth();
        // Only admin can delete messages
        allow delete: if isAdmin();
      }
    }

    // -----------------------------------------------------------------------
    // issues collection  (anonymous issue reporting)
    // -----------------------------------------------------------------------
    match /issues/{issueID} {

      // WRITE (create)
      // • Anyone — including unauthenticated users — may submit an issue.
      //   No UID is stored, so the report is truly anonymous.
      allow create: if true;

      // READ + UPDATE
      // • Only admin can read all issues and update status / adminResponse.
      allow read, update: if isAdmin();

      // DELETE — reserved for admin only
      allow delete: if isAdmin();
    }

    // -----------------------------------------------------------------------
    // Deny everything else by default
    // -----------------------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
